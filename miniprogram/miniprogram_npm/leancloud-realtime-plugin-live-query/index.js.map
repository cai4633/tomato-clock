{"version":3,"sources":["live-query.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('leancloud-realtime/core')) :\n  typeof define === 'function' && define.amd ? define('live-query', ['exports', 'leancloud-realtime/core'], factory) :\n  (global = global || self, factory(global.AV = global.AV || {}, global.AV));\n}(this, function (exports, core) { \n\n  function _inheritsLoose(subClass, superClass) {\n    subClass.prototype = Object.create(superClass.prototype);\n    subClass.prototype.constructor = subClass;\n    subClass.__proto__ = superClass;\n  }\n\n  function _toConsumableArray(arr) {\n    return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread();\n  }\n\n  function _arrayWithoutHoles(arr) {\n    if (Array.isArray(arr)) {\n      for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) arr2[i] = arr[i];\n\n      return arr2;\n    }\n  }\n\n  function _iterableToArray(iter) {\n    if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter);\n  }\n\n  function _nonIterableSpread() {\n    throw new TypeError(\"Invalid attempt to spread non-iterable instance\");\n  }\n\n  /* eslint-disable import/no-unresolved */\n\n  if (!core.Protocals) {\n    throw new Error('LeanCloud Realtime SDK not installed');\n  }\n\n  var CommandType = core.Protocals.CommandType,\n      GenericCommand = core.Protocals.GenericCommand,\n      AckCommand = core.Protocals.AckCommand;\n\n  var warn = function warn(error) {\n    return console.warn(error.message);\n  };\n\n  var LiveQueryClient =\n  /*#__PURE__*/\n  function (_EventEmitter) {\n    _inheritsLoose(LiveQueryClient, _EventEmitter);\n\n    function LiveQueryClient(appId, subscriptionId, connection) {\n      var _this;\n\n      _this = _EventEmitter.call(this) || this;\n      _this._appId = appId;\n      _this.id = subscriptionId;\n      _this._connection = connection;\n      _this._eventemitter = new core.EventEmitter();\n      _this._querys = new Set();\n      return _this;\n    }\n\n    var _proto = LiveQueryClient.prototype;\n\n    _proto._send = function _send(cmd) {\n      var _this$_connection;\n\n      for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n        args[_key - 1] = arguments[_key];\n      }\n\n      return (_this$_connection = this._connection).send.apply(_this$_connection, [Object.assign(cmd, {\n        appId: this._appId,\n        installationId: this.id,\n        service: 1\n      })].concat(args));\n    };\n\n    _proto._open = function _open() {\n      return this._send(new GenericCommand({\n        cmd: CommandType.login\n      }));\n    };\n\n    _proto.close = function close() {\n      var _ee = this._eventemitter;\n\n      _ee.emit('beforeclose');\n\n      return this._send(new GenericCommand({\n        cmd: CommandType.logout\n      })).then(function () {\n        return _ee.emit('close');\n      });\n    };\n\n    _proto.register = function register(liveQuery) {\n      this._querys.add(liveQuery);\n    };\n\n    _proto.deregister = function deregister(liveQuery) {\n      var _this2 = this;\n\n      this._querys.delete(liveQuery);\n\n      setTimeout(function () {\n        if (!_this2._querys.size) _this2.close().catch(warn);\n      }, 0);\n    };\n\n    _proto._dispatchCommand = function _dispatchCommand(command) {\n      if (command.cmd !== CommandType.data) {\n        this.emit('unhandledmessage', command);\n        return core.Promise.resolve();\n      }\n\n      return this._dispatchDataCommand(command);\n    };\n\n    _proto._dispatchDataCommand = function _dispatchDataCommand(_ref) {\n      var _ref$dataMessage = _ref.dataMessage,\n          ids = _ref$dataMessage.ids,\n          msg = _ref$dataMessage.msg;\n      this.emit('message', msg.map(function (_ref2) {\n        var data = _ref2.data;\n        return JSON.parse(data);\n      })); // send ack\n\n      var command = new GenericCommand({\n        cmd: CommandType.ack,\n        ackMessage: new AckCommand({\n          ids: ids\n        })\n      });\n      return this._send(command, false).catch(warn);\n    };\n\n    return LiveQueryClient;\n  }(core.EventEmitter);\n\n  var finalize = function finalize(callback) {\n    return [// eslint-disable-next-line no-sequences\n    function (value) {\n      return callback(), value;\n    }, function (error) {\n      callback();\n      throw error;\n    }];\n  };\n\n  var onRealtimeCreate = function onRealtimeCreate(realtime) {\n    /* eslint-disable no-param-reassign */\n    realtime._liveQueryClients = {};\n\n    realtime.createLiveQueryClient = function (subscriptionId) {\n      var _realtime$_open$then;\n\n      if (realtime._liveQueryClients[subscriptionId] !== undefined) {\n        return core.Promise.resolve(realtime._liveQueryClients[subscriptionId]);\n      }\n\n      var promise = (_realtime$_open$then = realtime._open().then(function (connection) {\n        var client = new LiveQueryClient(realtime._options.appId, subscriptionId, connection);\n        connection.on('reconnect', function () {\n          return client._open().then(function () {\n            return client.emit('reconnect');\n          }, function (error) {\n            return client.emit('reconnecterror', error);\n          });\n        });\n\n        client._eventemitter.on('beforeclose', function () {\n          delete realtime._liveQueryClients[client.id];\n        }, realtime);\n\n        client._eventemitter.on('close', function () {\n          realtime._deregister(client);\n        }, realtime);\n\n        return client._open().then(function () {\n          realtime._liveQueryClients[client.id] = client;\n\n          realtime._register(client);\n\n          return client;\n        });\n      })).then.apply(_realtime$_open$then, _toConsumableArray(finalize(function () {\n        if (realtime._deregisterPending) realtime._deregisterPending(promise);\n      })));\n\n      realtime._liveQueryClients[subscriptionId] = promise;\n      if (realtime._registerPending) realtime._registerPending(promise);\n      return promise;\n    };\n    /* eslint-enable no-param-reassign */\n\n  };\n\n  var beforeCommandDispatch = function beforeCommandDispatch(command, realtime) {\n    var isLiveQueryCommand = command.installationId && command.service === 1;\n    if (!isLiveQueryCommand) return true;\n    var targetClient = realtime._liveQueryClients[command.installationId];\n\n    if (targetClient) {\n      targetClient._dispatchCommand(command).catch(function (error) {\n        return console.warn(error);\n      });\n    } else {\n      console.warn('Unexpected message received without any live client match: %O', command);\n    }\n\n    return false;\n  }; // eslint-disable-next-line import/prefer-default-export\n\n\n  var LiveQueryPlugin = {\n    name: 'leancloud-realtime-plugin-live-query',\n    onRealtimeCreate: onRealtimeCreate,\n    beforeCommandDispatch: beforeCommandDispatch\n  };\n\n  exports.LiveQueryPlugin = LiveQueryPlugin;\n\n  Object.defineProperty(exports, '__esModule', { value: true });\n\n}));\n//# sourceMappingURL=live-query.js.map\n"]}